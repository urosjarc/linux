#!/usr/bin/env python2
"""
Description:
    Personal gadget interface.

Usage:
    gadget dic play <voice>
    gadget mp3 load audiobook
    gadget drive update

Options:
    -h --help   Extensive help message.
"""

from subprocess import Popen, PIPE, CalledProcessError
from docopt import docopt
import os
import json
import re
import fnmatch
import shutil

gadgets = {
    "sdc": {
        'uuid': '5C6B-303E',
        'alias': 'sdCard'
    },
    "dict": {
        'uuid': "0000-006F",
        'alias': 'dictaphone'
    },
    'mp3': {
        'uuid': "846D-FD0B",
        'alias': 'mp3player'
    }
}


def shell(command, catchErr=False, stdout=PIPE, stderr=PIPE, cwd=None):
    if isinstance(command, basestring):
        cmd = command.split()
    else:
        cmd = command

    output, err = Popen(cmd, stdout=stdout, stderr=stderr, cwd=cwd).communicate()

    if not catchErr and err != '':
        raise CalledProcessError(1, ' '.join(cmd), output=err)

    if catchErr:
        return err
    else:
        return output


def openImage(*path):
    return Popen('eog {}'.format(os.path.join(*path)).split(), stdout=PIPE, stderr=PIPE)


def getMountPoint(*path):
    return os.path.join('/media', os.environ.get("USER"), *path)


def findFiles(dir, glob):
    matches = []
    for root, dirnames, filenames in os.walk(dir):
        for filename in fnmatch.filter(filenames, glob):
            matches.append(os.path.join(root, filename))
    return matches


def moveToTrash(*path):
    shell('sudo gvfs-trash {}'.format(os.path.join(*path)))


def openAudioPlayer(*path):
    shell('vlc {}'.format(os.path.join(*path)), catchErr=True)


def gadgetsMounter(unmount=False):
    notFound = True
    lsblk = json.loads(
        shell('lsblk -f -J')
    )

    for blockdevice in lsblk['blockdevices']:

        devices = [blockdevice]
        if 'children' in blockdevice:
            devices += blockdevice['children']

        for device in devices:
            for i in gadgets:
                gadget = gadgets[i]
                if gadget['uuid'] == device['uuid']:
                    mountPoint = getMountPoint(gadget['alias'])

                    try:
                        if unmount:
                            print('Unmount: {}'.format(mountPoint))
                            shell('sudo unmount {} {}'.format(os.path.join('/dev', device['name']), mountPoint))
                        else:
                            print('Mount: {}'.format(mountPoint))
                            if not os.path.exists(mountPoint):
                                os.makedirs(mountPoint)
                            shell('sudo mount {} {}'.format(os.path.join('/dev', device['name']), mountPoint))
                    except:
                        None

                    notFound = False

    if (notFound):
        print('!!! No device is found...'.format())


def getDriveFolder(*path):
    return os.path.join('/home', os.environ.get("USER"), 'gdrive', *path)


def aaxToMp3(source):
    meta = aaxMetaInfo(source)

    cmdArr = 'ffmpeg -v error -stats -activation_bytes 0cedab08 -i {input} -vn -c:a libmp3lame -ab {bitrate}'.format(
        input=source,
        bitrate=meta['bitrate']
    ).split()

    cmdArr.append('{}'.format(meta['mp3']))

    shell(cmdArr, stdout=None, stderr=None, catchErr=True)


def aaxMetaInfo(source):
    meta = shell('ffprobe {}'.format(source), catchErr=True)

    author = re.findall('\s* artist \s*:\s*(.*)', meta)[0]
    title = re.sub('\s*\(\s*Unabridged\s*\)\s*', '', re.findall('title\s*:\s*(.*)', meta)[0])

    return {
        'mp3': re.sub(r'[\\/:"*?<>|]+', "", '{} - {}.mp3'.format(author, title)),
        'bitrate': re.findall('bitrate: (.*) kb\/s', meta)[0],
        'author': author,
        'title': title
    }


def updateDrive():
    print('Updating drive...')
    shell('grive --progress-bar', stdout=None, stderr=None, cwd=getDriveFolder()).communicate()


if __name__ == '__main__':

    args = docopt(__doc__)

    if args['dic'] or args['mp3']:
        gadgetsMounter()

    if args['dic']:
        if args['play']:

            # Get voices files.
            voicesPath = getMountPoint(gadgets['dict']['alias'], 'VOICE', args['<voice>'])
            voices = os.listdir(voicesPath)

            if len(voices) != 0:

                # Open image
                imageProcess = None
                if args['<voice>'] == 'A':
                    imageProcess = openImage(getDriveFolder('custva', 'emotions.jpg'))

                # Process every file in voices
                for file in voices:
                    print(' > {}'.format(file))

                    # Open audio player with file
                    filePath = os.path.join(voicesPath, file)
                    openAudioPlayer(filePath)

                    # Process emotional voices
                    if args['<voice>'] == 'A' and 'y' == raw_input('Upload file (y/n):'):
                        emotion = raw_input('Custvo: ')
                        drivePath = getDriveFolder('custva', emotion)
                        driveFilePath = os.path.join(drivePath, file)

                        # Create new emotion if not exist
                        if not (emotion in os.listdir(getDriveFolder('custva'))):
                            if 'y' == raw_input('mkdir "{}", nadaljuj (y/n):'.format(drivePath)):
                                os.makedirs(drivePath)

                        # Copy to emotion folder
                        shutil.copyfile(filePath, drivePath)
                        print(' > {}'.format(driveFilePath))

                    # Move to trash if user wants it
                    if 'y' == raw_input('Trash file (y/n):'):
                        moveToTrash(filePath)

                # Close image viewer
                if imageProcess:
                    imageProcess.terminate()

                # Update drive
                if 'y' == raw_input('Update drive (y/n):'):
                    updateDrive()

            # Warn on no file
            else:
                print(' > No file in "{}"'.format(voicesPath))

    elif args['mp3']:
        if args['load']:
            if args['audiobook']:

                # Get glob files .aax
                aaxFiles = findFiles(getMountPoint(gadgets['sdc']['alias']), '*.aax')

                # Process every aax file
                for aaxFile in aaxFiles:

                    # Get meta data of aax file
                    meta = aaxMetaInfo(aaxFile)

                    if 'y' == raw_input('Compile to mp3 & gdrive "{}" (y/n):'.format(meta['mp3'])):

                        # Get destinations and compiled path
                        driveAudio = getDriveFolder('knjige/audio', meta['mp3'])
                        mp3Music = getMountPoint(gadgets['mp3']['alias'], 'MUSIC', meta['mp3'])
                        createFile = os.path.join(os.getcwd(), meta['mp3'])

                        # Compile aax to mp3
                        aaxToMp3(aaxFile)

                        # Move & copy to destination
                        shutil.copyfile(createFile, driveAudio)
                        print(' > copy to {}'.format(driveAudio))
                        shutil.move(createFile, mp3Music)
                        print(' > move to {}'.format(mp3Music))

    elif args['drive']:
        if args['update']:
            updateDrive()

    # Unmount at the end
    gadgetsMounter(unmount=True)
